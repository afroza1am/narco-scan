<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NARCO-SCAN</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #1a1b26;
      --main-color: #24283b;
      --text-color: #c0caf5;
      --accent-color: #7aa2f7;
      --accent-hover: #9eceff;
      --border-color: #414868;
      --green: #9ece6a;
      --yellow: #e0af68;
      --red: #f7768e;
      --input-bg: #1f2430;
    }
    html, body {
      height: 100%;
      overflow: hidden;
    }
    body {
      font-family: 'Fira Code', monospace;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
    .cursor {
      display: inline-block;
      width: 10px;
      height: 1.2rem;
      background-color: var(--text-color);
      margin-left: 8px;
      animation: blink 1s step-end infinite;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-color); }
    ::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background-color: var(--accent-color); }

    .terminal-window {
      background-color: var(--main-color);
      border: 1px solid var(--border-color);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      height: calc(100vh - 4rem);
    }
    .terminal-header {
      background-color: var(--border-color);
      color: var(--bg-color);
    }
   
    .terminal-input {
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      outline: none;
      caret-color: var(--accent-color);
      color: var(--text-color);
      padding: 0.6rem 0.75rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
      font-size: 1.05rem;
      min-width: 220px;
    }
    .terminal-input::placeholder { color: #9aa4d6; opacity: 0.7; }
    .terminal-input:focus {
      border-color: var(--accent-color);
      box-shadow: 0 6px 24px rgba(122,162,247,0.08);
    }

    .terminal-btn {
      background-color: var(--accent-color);
      color: var(--main-color);
      transition: background-color 0.2s ease;
    }
    pre.terminal_ {
      font-family: inherit, Courier, monospace; 
      font-size: 58px;     
      color: #7aa2f7;      
      padding: 10px;
      border-radius: 10px;
      display: inline-block;
      line-height: 1.1;
      font-weight: 700;
      font-feature-settings: inherit;
    font-variation-settings: inherit;
    font-weight: inherit;
    line-height: inherit;
    letter-spacing: inherit;
    }
    p.terminal-desc {
      font-family: "Courier New", Courier, monospace; 
      font-size: 16px;    
      color: #00FF00;  
      padding-bottom: 8px; 
      padding-left: 30px;  
      margin: 0;
    }

    .terminal-btn:hover { background-color: var(--accent-hover); }
    #result pre { white-space: pre-wrap; word-wrap: break-word; }
    .keyword-tag { border: 1px solid var(--border-color); transition: all 0.2s ease; }
    .keyword-tag:hover { background-color: var(--accent-color); color: var(--main-color); border-color: var(--accent-color); }
    .chart-container { height: 500px !important; }
    .command-btn { color: var(--accent-color); cursor: pointer; text-decoration: underline; transition: color 0.2s ease; margin-right: 8px; }
    .command-btn:hover { color: var(--accent-hover); }
    .entity-pill { border:1px solid var(--border-color); padding:6px 8px; border-radius:6px; font-size:12px; margin:4px; display:inline-block; background: rgba(122,162,247,0.03); }
    @media (max-width: 768px) {
        .chart-container { height: 400px !important; }
        .terminal-window { height: calc(100vh - 2rem); }
    }
  </style>
</head>
<body class="p-4 sm:p-8">

  <div class="w-full h-full">
    <div class="terminal-window rounded-lg overflow-hidden flex flex-col">
      <div class="terminal-header p-3 flex items-center justify-between text-xs font-semibold flex-shrink-0">
        <span>/bin/bash -- NARCO-SCAN</span>
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 bg-red-500 rounded-full"></div>
          <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
          <div class="w-3 h-3 bg-green-500 rounded-full"></div>
        </div>
      </div>

      <div class="p-4 md:p-6 overflow-y-auto flex-grow" id="terminal-body">
        <pre class="terminal_">
            NARCO-SCAN
        </pre>
         <p class="terminal-desc">
This tool scans websites for potential illicit drug sells and similar activities in real-time.
  </p>

        <form id="checkForm" class="mb-2">
            <div class="flex items-center flex-wrap gap-3">
                <span class="text-green-400 mr-2 shrink-0">$</span>
                <input
                  type="text"
                  id="urlInput"
                  placeholder="enter target url..."
                  class="terminal-input flex-grow w-full md:w-auto"
                />
                <button type="submit" class="terminal-btn font-semibold px-4 py-2 rounded-md mt-2 md:mt-0 md:ml-4 w-full md:w-auto">
                    Execute
                </button>
            </div>
        </form>

        <div class="text-xs text-gray-500 mb-6 flex flex-wrap gap-x-4 gap-y-1">
          <span>Commands: <span class="command-btn" data-cmd="history">history</span>, <span class="command-btn" data-cmd="clear">clear</span> | Test Scripts:</span>
          <span class="command-btn" data-url="https://weed-crew.net/">https://weed-crew.net/</span>
          <span class="command-btn" data-url="https://purerocky.com/">https://purerocky.com/</span>
          <span class="command-btn" data-url="https://weedworldwidedelivery.com/">https://weedworldwidedelivery.com/</span>
        </div>

        <div id="result">
          <div id="defaultMessage">
            <p class="text-gray-400">Awaiting target...<span class="cursor"></span></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const GROQ_API_KEY = "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";

    const allKeywords = [ "cocaine", "heroin", "meth", "methamphetamine", "crystal meth", "mdma", "molly", "ecstasy", "lsd", "acid", "shrooms", "magic mushrooms", "psilocybin", "dmt", "ketamine", "special k", "ghb", "gbl", "pcp", "angel dust", "crack", "crack cocaine", "opium", "fentanyl", "flakka", "bath salts", "spice", "k2", "xanax", "alprazolam", "bars", "footballs", "oxycontin", "oxycodone", "percocet", "hydrocodone", "vicodin", "tramadol", "codeine", "lean", "purple drank", "adderall", "dextroamphetamine", "ritalin", "methylphenidate", "valium", "diazepam", "ativan", "clonazepam", "klonopin", "soma", "zanaflex", "blow", "coke", "snow", "flake", "yayo", "smack", "dope", "junk", "brown sugar", "china white", "skag", "tar", "crank", "ice", "glass", "tina", "rolls", "tabs", "lucy", "lucifer", "boomers", "caps", "liberty caps", "chronic", "weed", "pot", "bud", "herb", "ganja", "mary jane", "reefer", "dank", "mids", "regs", "loud", "zaza", "kush", "haze", "yayo dust", "booger sugar", "fire", "pookie", "zoinked", "black mamba strain", "agent orange marijuana strain", "gary payton marijuana strain", "durban poison strain", "strawberry cough marijuana strain", "kyle sweet island strain", "5 alive marijuana strain", "do-si-dos marijuana strain", "cake bomb marijuana strain", "glookies marijuana strain", "space runtz marijuana strain", "skilatti strain", "pink certz marijuana strain", "giraffe puzzy strain", "vegan mushroom", "punch bar cream edibles", "punch bar combo", "polka dot magic belgian chocolate bars", "milk magic mushroom chocolate bars", "cookies and cream", "assorted 20 pack chocolate bars", "lemon tree dankwoods", "sour diesel dankwoods", "skywalker og dankwoods", "backwoods honey bourbon", "russian cream backwoods", "backwoods honey berry", "backwoods dark stout", "2c-b", "2c-i", "2c-e", "nbome", "mxe", "etizolam", "flualprazolam", "clonazolam", "mephedrone", "mdpv", "alpha-pvp", "bk-mdma", "bk-2cb", "4-mec", "am-2201", "jwh-018", "jwh-073", "pentylone", "eutylone", "hexen", "isopropylphenidate", "5-meo-dmt", "darknet", "darkweb", "onion", "tor", "silk road", "alphabay", "dream market", "empire market", "hydra market", "vendor", "buyer", "plug", "connect", "stealth shipping", "escrow", "reship", "trip report", "lab tested", "clean sample", "purity", "crypto", "bitcoin", "monero", "altcoin", "burner phone", "baggie", "dime", "dub", "eighth", "quarter", "zip", "oz", "gram", "key", "brick", "slab", "ounce", "bar", "pill", "tab", "blotter", "gel tab", "rock", "point", "point one", "rig", "rail", "bump", "hit", "line", "shot", "cap", "spoon", "snort", "sniff", "shoot", "inject", "iv", "im", "toke", "smoke", "bake", "roll", "plug", "boof", "slam", "trip", "dose", "microdose", "candyflip", "hippieflip", "nod", "nodding", "buzz", "high", "faded", "twisted", "zooted", "blasted", "geeked", "lit", "tripping", "rolling", "spun", "cut", "stepped on", "laced", "cook", "freebase", "base", "shake and bake", "crush", "dissolve", "break down", "stash", "stash spot", "re-up", "bag up", "cap up", "serve", "push", "trap", "traphouse", "cookhouse", "hot plate", "lighter", "foil", "needle", "tourniquet", "bong", "pipe", "bowl", "dab rig", "torch", "syringe", "cotton", "belt", "roach clip", "papers", "wrap", "blunt", "joint", "spliff", "vape", "dab", "wax", "oil", "shatter", "crumble", "x@n@x", "w33d", "m3th", "h3r0in", "5hro0ms", "l$D", "m@riju@na", "r1talin", "dr@nk", "dr@g", "0xy", "ad3rall", "b3nz0s", "p3rcs", "f3nt", "p!lls", "b@rs", "j$oint", "sn!ff", "sh00t" ];

    const keywordCategories = {
      "Opioids": ["heroin", "fentanyl", "oxycontin", "oxycodone", "percocet", "hydrocodone", "vicodin", "tramadol", "codeine", "opium"],
      "Stimulants": ["cocaine", "meth", "methamphetamine", "crystal meth", "mdma", "molly", "ecstasy", "adderall", "dextroamphetamine", "ritalin", "methylphenidate", "flakka"],
      "Depressants": ["xanax", "alprazolam", "valium", "diazepam", "ativan", "clonazepam", "klonopin", "ghb", "gbl"],
      "Hallucinogens": ["lsd", "acid", "shrooms", "magic mushrooms", "psilocybin", "dmt", "ketamine", "pcp", "angel dust"],
      "Cannabinoids": ["weed", "pot", "bud", "herb", "ganja", "mary jane", "reefer", "kush", "haze", "chronic", "dank", "zaza"],
      "Dark-Web-&-Crypto": ["darknet", "darkweb", "onion", "tor", "silk road", "alphabay", "vendor", "escrow", "crypto", "bitcoin", "monero", "btc", "xmr"],
      "Slang-&-General": ["lean", "purple drank", "spice", "k2", "bath salts", "blow", "coke", "snow", "smack", "dope", "junk", "crack", "ice", "pills", "bars", "tabs"]
    };

    Chart.defaults.color = '#c0caf5';
    Chart.defaults.borderColor = '#414868';
    Chart.defaults.font.family = "'Fira Code', monospace";

    const form = document.getElementById('checkForm');
    const urlInput = document.getElementById('urlInput');
    const resultDiv = document.getElementById('result');
    const terminalBody = document.getElementById('terminal-body');

    function logProgress(message, status = "") {
        const line = document.createElement('p');
        const statusColor = status === "[DONE]" ? 'text-[var(--green)]' : status === "[ERROR]" ? 'text-[var(--red)]' : status === "[WARN]" ? 'text-[var(--yellow)]' : 'text-gray-500';
        line.innerHTML = `> ${message}... <span class="${statusColor} font-semibold">${status}</span>`;
        resultDiv.appendChild(line);
        terminalBody.scrollTop = terminalBody.scrollHeight;
    }

    function stripHtml(html) {
       const doc = new DOMParser().parseFromString(html, 'text/html');
       doc.querySelectorAll('script, style, link, meta, noscript').forEach(el => el.remove());
       return doc.body.textContent || "";
    }

    function escapeRegex(string) {
        return string.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    }

    async function getAiAnalysis(text, apiKey) {
        if (!apiKey) {
            logProgress("AI analysis skipped", "[NO API KEY]");
            return null;
        }
        logProgress("Contacting Groq AI for contextual analysis");

        const systemPrompt = `You are a cyber intelligence analyst. Analyze the provided text for indications of illicit drug sales, trade, or glorification. Ignore medical, news, or harm-reduction-only contexts. Output ONLY valid JSON (no surrounding text) matching this schema:
{
  "riskScore": number,
  "justification": "string",
  "categories": {
    "Opioids": number,
    "Stimulants": number,
    "Depressants": number,
    "Hallucinogens": number,
    "Cannabinoids": number,
    "Dark-Web-&-Crypto": number
  },
  "entities": {
    "drugs": ["string"],
    "markets": ["string"],
    "payment": ["string"],
    "contacts": ["string"]
  }
}
Ensure numbers are integers between 0 and 100. ONLY return JSON.`;

        const userPrompt = `Text: "${text.substring(0, 4000)}"`;

        const body = {
            model: "llama-3.3-70b-versatile",
            messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: userPrompt }
            ],
            temperature: 0.15,
            max_tokens: 600
        };

        try {
            const resp = await fetch("http://localhost:3000/groq-proxy", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            const data = await resp.json();
            if (!resp.ok) {
                throw new Error(`Groq API failed: ${JSON.stringify(data)}`);
            }

         
            let content = null;
            try {
                content = data.choices?.[0]?.message?.content ?? data.choices?.[0]?.text ?? null;
            } catch (e) {
                content = null;
            }

            if (!content) {
                if (data.riskScore !== undefined) return data;
                throw new Error("No usable content from Groq response.");
            }

          
            let aiData = null;
            try {
                aiData = JSON.parse(content);
            } catch (e) {
                const m = content.match(/\{[\s\S]*\}/);
                if (m) {
                    try { aiData = JSON.parse(m[0]); } catch (e2) { aiData = null; }
                }
            }

            if (!aiData || aiData.riskScore === undefined) {
                const scoreMatch = (content || "").match(/(\d{1,3})\s*%/);
                const score = scoreMatch ? Math.max(0, Math.min(100, parseInt(scoreMatch[1], 10))) : 0;
                aiData = aiData || {};
                aiData.riskScore = aiData.riskScore ?? score;
                aiData.justification = aiData.justification ?? (typeof content === 'string' ? content.substring(0, 400) : "No justification provided.");
                aiData.categories = aiData.categories ?? { "Opioids":0, "Stimulants":0, "Depressants":0, "Hallucinogens":0, "Cannabinoids":0, "Dark-Web-&-Crypto":0 };
                aiData.entities = aiData.entities ?? { drugs:[], markets:[], payment:[], contacts:[] };
            }

            aiData.categories = aiData.categories || { "Opioids":0, "Stimulants":0, "Depressants":0, "Hallucinogens":0, "Cannabinoids":0, "Dark-Web-&-Crypto":0 };
            Object.keys(aiData.categories).forEach(k => {
                let v = parseInt(aiData.categories[k],10);
                if (isNaN(v)) v = 0;
                aiData.categories[k] = Math.max(0, Math.min(100, v));
            });

            logProgress("AI analysis received", "[DONE]");
            return aiData;
        } catch (error) {
            console.error("Full AI analysis error:", error);
            logProgress(`AI analysis failed: ${error.message}`, "[ERROR]");
            return null;
        }
    }

    function checkHeuristics(text, url) {
        let findings = [];
        if (/\b(bitcoin|monero|btc|xmr)\b/i.test(text)) {
            findings.push({ type: 'Crypto Mention', detail: 'Bitcoin/Monero keyword found.'});
        }
        if (/\.onion\b/.test(url)) {
            findings.push({ type: 'Dark Web', detail: 'Domain is a .onion address (Tor network).'});
        }
        return findings;
    }

    async function fetchIpData(domain) {
        try {
            const ipResponse = await fetch(`https://dns.google/resolve?name=${domain}&type=A`);
            const ipData = await ipResponse.json();
            if (!ipData.Answer || ipData.Answer.length === 0) return { error: "Could not resolve IP" };
            const ip = ipData.Answer[0].data;
            const locationResponse = await fetch(`https://ipapi.co/${ip}/json/`);
            const locationData = await locationResponse.json();
            return { ip, locationData };
        } catch (error) {
            return { error: "Could not fetch location data" };
        }
    }

    function extractMetadata(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const metaTags = Array.from(doc.querySelectorAll('meta')).reduce((acc, tag) => {
            const name = tag.getAttribute('name') || tag.getAttribute('property');
            if (name) acc[name.toLowerCase()] = tag.getAttribute('content');
            return acc;
        }, {});
        const title = doc.querySelector('title')?.textContent || 'N/A';
        const emails = Array.from(new Set(html.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi) || []));
        const phones = Array.from(new Set(html.match(/(\+\d{1,3}[- ]?)?(\(\d{3}\)|\d{3})[- ]?\d{3}[- ]?\d{4}/g) || []));
        return { title, metaTags, emails, phones, doc };
    }

    async function createWebsiteDetails(url, html) {
        logProgress("Fetching website intelligence");
        const domain = url.replace(/^(https?:\/\/)?(www\.)?/, '').split('/')[0];
        const metadataObj = extractMetadata(html);
        const metadata = metadataObj.metaTags;
        const doc = metadataObj.doc;
        const ipData = await fetchIpData(domain);
        logProgress("Fetching website intelligence", "[DONE]");

        // Gather richer details
        const canonical = doc.querySelector('link[rel="canonical"]')?.getAttribute('href') || 'N/A';
        const favicon = (doc.querySelector('link[rel~="icon"]')?.getAttribute('href') || doc.querySelector('link[rel="shortcut icon"]')?.getAttribute('href')) || 'N/A';
        const description = metadata.description || metadata['og:description'] || metadata['twitter:description'] || 'N/A';
        const ogTitle = metadata['og:title'] || metadata['twitter:title'] || 'N/A';
        const robots = metadata.robots || 'N/A';
        const h1s = Array.from(doc.querySelectorAll('h1')).map(h => h.textContent.trim()).filter(Boolean).slice(0,5);
        const h2s = Array.from(doc.querySelectorAll('h2')).map(h => h.textContent.trim()).filter(Boolean).slice(0,5);
        const images = Array.from(doc.querySelectorAll('img')).map(i => i.getAttribute('src')).slice(0,10);
        const linkNodes = Array.from(doc.querySelectorAll('a[href]'));
        let totalLinks = linkNodes.length;
        let externalLinks = [];
        try {
            externalLinks = linkNodes.map(a => {
                try { return new URL(a.href, url).href; } catch(e) { return null; }
            }).filter(Boolean).filter(href => {
                try { return new URL(href).hostname !== domain; } catch(e){ return false; }
            }).slice(0,10);
        } catch (e) { externalLinks = []; }

        const forms = Array.from(doc.querySelectorAll('form')).map(f => ({ action: f.getAttribute('action') || 'N/A', method: (f.getAttribute('method')||'GET').toUpperCase() })).slice(0,10);

        // JSON-LD structured data
        const jsonLdNodes = Array.from(doc.querySelectorAll('script[type="application/ld+json"]'));
        const jsonLd = [];
        jsonLdNodes.slice(0,5).forEach(s => {
            try {
                const parsed = JSON.parse(s.textContent);
                jsonLd.push(parsed);
            } catch (e) {
                // skip invalid
            }
        });

        // Price and crypto detections
        const priceMatches = Array.from(html.matchAll(/(\$\s?\d{1,3}(?:,\d{3})*(?:\.\d+)?)/g)).map(m => m[0]).slice(0,10);
        const unitMatches = Array.from(html.matchAll(/\b(\d+(?:\.\d+)?\s?(?:gram|g|oz|ounce|kg|kg\.)\b)/gi)).map(m => m[0]).slice(0,10);
        const cryptoMention = (/\b(bitcoin|btc|monero|xmr|ethereum|eth)\b/i.test(html)) ? 'Yes' : 'No';
        const telegramLinks = Array.from(doc.querySelectorAll('a[href*="t.me"], a[href*="telegram"]')).map(a => a.href).slice(0,10);
        const onionLinks = Array.from(doc.querySelectorAll('a[href*=".onion"]')).map(a => a.href).slice(0,10);

       
        const textOnly = stripHtml(html);
        const wordCount = textOnly.split(/\s+/).filter(Boolean).length;

        let report = `<h3 class="font-bold text-lg mb-2 mt-6 text-[var(--accent-color)]">[ Website Intelligence Report ]</h3><pre>`;
        report += `[+] Domain Info\n`;
        report += `    - Domain        : ${domain}\n`;
        report += `    - Title         : ${metadataObj.title.substring(0,120)}\n`;
        report += `    - Canonical     : ${canonical}\n`;
        report += `    - Favicon       : ${favicon}\n`;
        report += `\n[+] Meta Data\n`;
        report += `    - Description   : ${description.substring(0,200)}\n`;
        report += `    - OpenGraph Title: ${ogTitle}\n`;
        report += `    - Robots        : ${robots}\n`;
        report += `\n[+] Content Structure\n`;
        report += `    - Word Count    : ${wordCount}\n`;
        report += `    - H1 (sample)   : ${h1s.length ? h1s.join(' | ') : 'None'}\n`;
        report += `    - H2 (sample)   : ${h2s.length ? h2s.join(' | ') : 'None'}\n`;
        report += `    - Images found  : ${images.length}\n`;
        report += `\n[+] Links & Forms\n`;
        report += `    - Total Links   : ${totalLinks}\n`;
        report += `    - External (sample up to 10): ${externalLinks.length ? externalLinks.join(', ') : 'None'}\n`;
        report += `    - Forms (sample up to 10): ${forms.length ? forms.map(f=>`${f.method} ${f.action}`).join(' ; ') : 'None'}\n`;
        report += `\n[+] Structured Data\n`;
        report += `    - JSON-LD blocks found: ${jsonLd.length}\n`;
        if (jsonLd.length > 0) {
            try {
                const types = jsonLd.map(j => {
                    if (Array.isArray(j)) return j.map(x => x['@type']||x.type||'').join(',');
                    return j['@type'] || j.type || JSON.stringify(j).slice(0,40);
                }).slice(0,3);
                report += `    - JSON-LD (sample types): ${types.join(' | ')}\n`;
            } catch (e) {}
        }
        report += `\n[+] Pricing & Payment Indicators\n`;
        report += `    - Price Patterns (sample): ${priceMatches.length ? priceMatches.join(', ') : 'None'}\n`;
        report += `    - Unit Matches (sample): ${unitMatches.length ? unitMatches.join(', ') : 'None'}\n`;
        report += `    - Crypto mentions: ${cryptoMention}\n`;
        report += `    - Telegram links (sample): ${telegramLinks.length ? telegramLinks.join(', ') : 'None'}\n`;
        report += `    - .onion links (sample): ${onionLinks.length ? onionLinks.join(', ') : 'None'}\n`;
        report += `\n[+] Contact & Security\n`;
        report += `    - IP Address    : ${ipData.ip || 'N/A'}\n`;
        report += `    - ISP           : ${ipData.locationData?.org || 'N/A'}\n`;
        report += `    - Location      : ${ipData.locationData?.city || 'N/A'}, ${ipData.locationData?.country_name || 'N/A'}\n`;
        report += `    - Emails        : ${metadataObj.emails.length > 0 ? metadataObj.emails.slice(0, 5).join(', ') : 'None found'}\n`;
        report += `    - Phones        : ${metadataObj.phones.length > 0 ? metadataObj.phones.slice(0,5).join(', ') : 'None found'}\n`;
        report += `</pre>`;
        return report;
    }

    function renderTermFrequencyChart(canvasId, termFrequency) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const sortedTerms = Object.entries(termFrequency).sort((a, b) => b[1] - a[1]).slice(0, 15);
        new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: { labels: sortedTerms.map(item => item[0]), datasets: [{ label: 'Mentions', data: sortedTerms.map(item => item[1]), backgroundColor: 'rgba(122, 162, 247, 0.4)', borderColor: 'rgba(122, 162, 247, 1)', borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, grid: { color: 'rgba(65, 72, 104, 0.5)' }, ticks: { precision: 0 } }, y: { grid: { display: false }, ticks: { font: { size: 10 } } } }, plugins: { legend: { display: false } } }
        });
    }

    function renderCategoryChart(canvasId, categories) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const labels = Object.keys(categories);
        const data = labels.map(k => categories[k] ?? 0);
        new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Category Risk', data, backgroundColor: 'rgba(122,162,247,0.45)', borderColor: 'rgba(122,162,247,1)', borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    function saveScanToHistory(scanData) {
        let history = JSON.parse(localStorage.getItem('narcoScanHistory')) || [];
        history.unshift(scanData);
        if (history.length > 10) history = history.slice(0, 10);
        localStorage.setItem('narcoScanHistory', JSON.stringify(history));
    }

    function displayHistory() {
        resultDiv.innerHTML = '';
        const history = JSON.parse(localStorage.getItem('narcoScanHistory')) || [];
        if (history.length === 0) {
            resultDiv.innerHTML = '<p>No scan history found.</p>';
            return;
        }
        let historyHtml = '<h3 class="font-bold text-lg mb-2 text-[var(--accent-color)]">[ Scan History (Last 10) ]</h3><pre>';
        history.forEach(item => {
            const date = new Date(item.date).toLocaleString();
            let riskColor = "text-[var(--green)]";
            const finalScore = item.aiScore ?? item.keywordScore;
            if(finalScore > 60) riskColor = "text-[var(--red)]";
            else if (finalScore > 30) riskColor = "text-[var(--yellow)]";
            historyHtml += `[${date}] <span class="${riskColor}">Risk: ${finalScore}%</span> ${item.url}\n`;
        });
        historyHtml += '</pre>';
        resultDiv.innerHTML = historyHtml;
    }

    async function runScan(url) {
        if (!url || !url.startsWith('http')) {
            resultDiv.innerHTML = `<p class="text-[var(--red)]">Invalid URL provided. Please include http/https.</p>`;
            return;
        }

        resultDiv.innerHTML = '';
        logProgress(`Initializing scan for ${url}`);

        try {
            logProgress("Fetching URL content");
            const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
            if (!response.ok) throw new Error("Site may be down or blocking requests.");
            const html = await response.text();
            logProgress("Fetching URL content", "[DONE]");

            logProgress("Analyzing text content");
            const textContent = stripHtml(html);
            logProgress(`Analyzing text content (${textContent.length} chars)`, "[DONE]");

            const aiReport = await getAiAnalysis(textContent, GROQ_API_KEY);

            const termFrequency = {};
            const foundKeywordsByCategory = {};

            allKeywords.forEach(keyword => {
                const matches = textContent.match(new RegExp(escapeRegex(keyword), 'gi'));
                if (matches) {
                    termFrequency[keyword] = (termFrequency[keyword] || 0) + matches.length;
                }
            });

            Object.entries(keywordCategories).forEach(([category, keywords]) => {
                keywords.forEach(keyword => {
                    if (termFrequency[keyword]) {
                        if (!foundKeywordsByCategory[category]) foundKeywordsByCategory[category] = [];
                        foundKeywordsByCategory[category].push(keyword);
                    }
                });
            });

            const heuristics = checkHeuristics(textContent, url);
            let keywordScore = Math.min(100, Math.round((Object.keys(termFrequency).length / 50) * 100) + (heuristics.length * 10));

            let output = '<br>';
            if (aiReport) {
                let riskColor = "text-[var(--green)]";
                if (aiReport.riskScore > 60) riskColor = "text-[var(--red)]";
                else if (aiReport.riskScore > 30) riskColor = "text-[var(--yellow)]";

                output += `<h3 class="font-bold text-lg mb-2 text-[var(--accent-color)]">[ AI Threat Assessment ]</h3>
                           <pre>AI Risk Score: <span class="font-bold ${riskColor}">${aiReport.riskScore}%</span>\nJustification: ${aiReport.justification}</pre>`;

                if (aiReport.categories && Object.keys(aiReport.categories).length > 0) {
                    output += `<div class="my-6">
                                  <h3 class="font-bold text-lg mb-2 text-[var(--accent-color)]">[ Category Breakdown ]</h3>
                                  <div class="chart-container relative"><canvas id="categoryChartCanvas"></canvas></div>
                               </div>`;
                }

                if (aiReport.entities) {
                    const drugs = (aiReport.entities.drugs || []).slice(0,20);
                    const markets = (aiReport.entities.markets || []).slice(0,20);
                    const payment = (aiReport.entities.payment || []).slice(0,20);
                    const contacts = (aiReport.entities.contacts || []).slice(0,20);

                    output += `<div class="my-6">
                                <h3 class="font-bold text-lg mb-2 text-[var(--accent-color)]">[ Extracted Entities ]</h3>
                                <div class="mb-2"><strong>Drugs:</strong> ${drugs.length ? drugs.map(x=>`<span class="entity-pill">${x}</span>`).join('') : 'None'}</div>
                                <div class="mb-2"><strong>Markets:</strong> ${markets.length ? markets.map(x=>`<span class="entity-pill">${x}</span>`).join('') : 'None'}</div>
                                <div class="mb-2"><strong>Payment:</strong> ${payment.length ? payment.map(x=>`<span class="entity-pill">${x}</span>`).join('') : 'None'}</div>
                                <div class="mb-2"><strong>Contacts:</strong> ${contacts.length ? contacts.map(x=>`<span class="entity-pill">${x}</span>`).join('') : 'None'}</div>
                               </div>`;
                }

            } else {
                 output += `<h3 class="font-bold text-lg mb-2 text-[var(--accent-color)]">[ Keyword-Based Assessment ]</h3>
                           <pre>Keyword Risk Score: <span class="font-bold">${keywordScore}%</span></pre>`;
            }

            

            if (Object.keys(termFrequency).length > 0) {
                output += `<div class="my-6">
                    <h3 class="font-bold text-lg mb-2 text-[var(--accent-color)]">[ Top 15 Term Mentions ]</h3>
                    <div class="chart-container relative"><canvas id="termChartCanvas"></canvas></div>
                </div>`;
            }

            if (heuristics.length > 0) {
                output += `<div class="my-6">
                    <h3 class="font-bold text-lg mb-2 text-[var(--red)]">[ Heuristic Red Flags ]</h3>
                    <pre>${heuristics.map(h => `- ${h.type}: ${h.detail}`).join('\n')}</pre>
                </div>`;
            }

            const websiteDetails = await createWebsiteDetails(url, html);
            resultDiv.innerHTML += output + websiteDetails;

            if (aiReport && aiReport.categories && Object.keys(aiReport.categories).length > 0) {
                renderCategoryChart('categoryChartCanvas', aiReport.categories);
            }

            if (Object.keys(termFrequency).length > 0) {
              renderTermFrequencyChart('termChartCanvas', termFrequency);
            }

            saveScanToHistory({ url, aiScore: aiReport?.riskScore, keywordScore, date: new Date().toISOString() });

        } catch (err) {
            logProgress(`Scan failed: ${err.message}`, "[ERROR]");
        }
    }

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const command = urlInput.value.trim().toLowerCase();
        if (command === "history") {
            displayHistory();
        } else if (command === "clear") {
            resultDiv.innerHTML = '<p>Awaiting target...<span class="cursor"></span></p>';
        } else {
            runScan(urlInput.value);
        }
        if (command !== "history") urlInput.value = '';
    });

    document.querySelectorAll('.command-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const url = e.target.dataset.url;
        const cmd = e.target.dataset.cmd;
        if (url) {
            urlInput.value = url;
            runScan(url);
            return;
        }
        if (cmd) {
            const testUrls = {
                'test-high': 'https://en.wikipedia.org/wiki/Cocaine',
                'test-med': 'https://psychonautwiki.org/wiki/Main_Page',
                'test-clean': 'https://www.google.com'
            };
            if (cmd in testUrls) {
                urlInput.value = testUrls[cmd];
                runScan(testUrls[cmd]);
            } else {
                urlInput.value = cmd;
                form.dispatchEvent(new Event('submit', {cancelable: true}));
            }
        }
      });
    });

  </script>
</body>
</html>
